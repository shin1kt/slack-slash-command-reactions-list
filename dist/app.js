(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=require("dotenv");var n=e.n(t);const s=require("express");var a=e.n(s);const r=require("crypto");var o=e.n(r);const i=require("axios");var c=e.n(i);const d=async e=>{const t={headers:{"Content-type":"application/x-www-form-urlencoded",Authorization:`Bearer ${e}`}};return await c().get("https://slack.com/api/users.list?pretty=1",t).then((e=>e.data.members.map((e=>({id:e.id,name:e.name,real_name:e.profile.real_name})))))},p=async(e,t,n)=>{const s=`https://slack.com/api/reactions.get?channel=${t}&timestamp=${n}&pretty=1`,a={headers:{"Content-type":"application/x-www-form-urlencoded",Authorization:`Bearer ${e}`}};return await c().get(s,a).then((e=>e.data.message?.reactions??e.data.file?.reactions??[]))},u=async(e,t)=>{const n=`https://slack.com/api/conversations.members?channel=${t}&pretty=1`,s={headers:{"Content-type":"application/x-www-form-urlencoded",Authorization:`Bearer ${e}`}};return await c().get(n,s).then((e=>e.data.members??[]))},l=require("validator");var m=e.n(l);const h=async(e,t,n)=>{const s=t.channel_id,a=t.text;if(!a||!m().isURL(a))return void n.status(200).send("引数に対象コメントのURLを指定してください").end();const r=(Number(a.split("?")?.shift()?.split("/")?.pop()?.slice(1))/1e6).toFixed(6);if(!Number(r))return void n.status(200).send("引数の形式が正しくありません").end();const o=await(async(e,t,n)=>{const s=[await d(e),await p(e,t,n),await u(e,t)];return await Promise.all(s).then((e=>{const t=e[0],n=e[1],s=e[2],a=[],r=n.map((e=>({type:"section",text:{type:"mrkdwn",text:`:${e.name}: (${e.users.length}人) \n ${e.users.map((e=>(a.push(e),m().escape(t.find((t=>t.id===e))?.real_name??e)))).join("\n")}`}}))),o=s.reduce(((e,n)=>{if(!a.includes(n)){const s=m().escape(t.find((e=>e.id===n))?.real_name??n);e.push(s)}return e}),[]);return r.push({type:"section",text:{type:"mrkdwn",text:`:未回答: (${o.length}人) \n ${o.join("\n")}`}}),r}))})(e,s,r);!o||o.length<1?n.status(200).send("データ取得失敗").end():(o.push({type:"section",text:{type:"mrkdwn",text:t.text}}),n.json({blocks:o}))};n().config();const y=process.env.SLACK_TOKEN??"",w=process.env.SLACK_SIGNING_SECRET??"",v=a()();v.use(a().json()),v.use(a().urlencoded({extended:!0,verify:(e,t,n,s)=>{e.rawBody=n.toString(s??"utf8")}})),v.post("/slash/reactions",(async(e,t)=>{(async(e,t,n)=>{const s=e.rawBody,a=String(e.headers["x-slack-request-timestamp"])??"";if(Math.abs(parseInt(a,10)-Math.floor((new Date).getTime()/1e3))>300)return void t.sendStatus(403);const r=`v0:${a}:${s}`;e.headers["x-slack-signature"]===`v0=${o().createHmac("sha256",n).update(r).digest("hex")}`||t.sendStatus(403)})(e,t,w),await h(y,e.body,t)}));const f=process.env.PORT||8080;v.listen(f,(()=>{console.log(`App listening on port ${f}`),console.log("Press Ctrl+C to quit.")}))})();